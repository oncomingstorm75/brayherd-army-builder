<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beastmen Brayherds Army Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c1810 0%, #1a0f08 100%);
            color: #f0e6d2;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #8b4513;
        }
        
        h1 {
            font-size: 2.5em;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
        }
        
        .points-total {
            font-size: 1.5em;
            color: #ff6b35;
            margin-top: 10px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .unit-browser, .army-list {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
        }
        
        h2 {
            color: #d4af37;
            margin-bottom: 15px;
            font-size: 1.8em;
            border-bottom: 2px solid #8b4513;
            padding-bottom: 10px;
        }
        
        .category {
            margin-bottom: 25px;
        }
        
        .category-title {
            color: #ff6b35;
            font-size: 1.3em;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        .category-title:hover {
            color: #ff8c5a;
        }
        
        .unit-card {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #6b3410;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .unit-card:hover {
            background: rgba(0, 0, 0, 0.7);
            border-color: #8b4513;
        }
        
        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .unit-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #f0e6d2;
        }
        
        .unit-cost {
            color: #d4af37;
            font-weight: bold;
        }
        
        .unit-stats {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 5px;
            font-size: 0.9em;
            margin: 10px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-label {
            color: #d4af37;
            font-weight: bold;
        }
        
        .special-rules {
            font-size: 0.85em;
            color: #aaa;
            margin: 8px 0;
        }
        
        button {
            background: #8b4513;
            color: #f0e6d2;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #a0522d;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .army-unit {
            background: rgba(139, 69, 19, 0.2);
            border: 1px solid #8b4513;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .army-unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .remove-btn {
            background: #8b2500;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        
        .remove-btn:hover {
            background: #a52a00;
        }
        
        .options-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #6b3410;
        }
        
        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            font-size: 0.9em;
        }
        
        .option-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        input[type="number"] {
            width: 60px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #8b4513;
            color: #f0e6d2;
            border-radius: 3px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .controls button {
            flex: 1;
            min-width: 120px;
        }
        
        .magic-items-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #6b3410;
        }
        
        .magic-item-category {
            margin-bottom: 15px;
        }
        
        .magic-item-title {
            color: #d4af37;
            font-size: 1em;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .magic-item {
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .magic-item:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .magic-item.selected {
            background: rgba(139, 69, 19, 0.4);
            border: 1px solid #d4af37;
        }
        
        .magic-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .magic-item-desc {
            font-size: 0.85em;
            color: #aaa;
        }
        
        .error-message {
            color: #ff6b6b;
            background: rgba(255, 0, 0, 0.1);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ff6b6b;
            margin: 10px 0;
        }
        
        .hidden {
            display: none;
        }
        
        .model-count {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üêê Beastmen Brayherds Army Builder üêê</h1>
            <div class="points-total">Total Points: <span id="totalPoints">0</span></div>
        </header>
        
        <div class="main-content">
            <div class="unit-browser">
                <h2>Unit Browser</h2>
                <div id="unitBrowser"></div>
            </div>
            
            <div class="army-list">
                <h2>Your Army</h2>
                <div id="armyList"></div>
                <div class="controls">
                    <button onclick="clearArmy()">Clear Army</button>
                    <button onclick="saveArmy()">Save Army</button>
                    <button onclick="loadArmy()">Load Army</button>
                    <button onclick="exportText()">Export as Text</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let armyData = null;
        let currentArmy = [];
        let nextUnitId = 1;

        // Load army data from JSON file
        async function loadArmyData() {
            try {
                const response = await fetch('beastmen-data.json');
                armyData = await response.json();
                renderUnitBrowser();
                loadArmyFromStorage();
            } catch (error) {
                document.getElementById('unitBrowser').innerHTML = 
                    '<div class="error-message">Error loading army data. Make sure beastmen-data.json is in the same folder.</div>';
            }
        }

        function renderUnitBrowser() {
            const browser = document.getElementById('unitBrowser');
            browser.innerHTML = '';
            
            for (const [categoryKey, category] of Object.entries(armyData.categories)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = `‚ñº ${category.name}`;
                categoryTitle.onclick = () => toggleCategory(categoryKey);
                
                const unitsDiv = document.createElement('div');
                unitsDiv.id = `category-${categoryKey}`;
                
                category.units.forEach(unit => {
                    unitsDiv.appendChild(createUnitCard(unit));
                });
                
                categoryDiv.appendChild(categoryTitle);
                categoryDiv.appendChild(unitsDiv);
                browser.appendChild(categoryDiv);
            }
        }

        function createUnitCard(unit) {
            const card = document.createElement('div');
            card.className = 'unit-card';
            
            const header = document.createElement('div');
            header.className = 'unit-header';
            
            const name = document.createElement('div');
            name.className = 'unit-name';
            name.textContent = unit.name;
            
            const cost = document.createElement('div');
            cost.className = 'unit-cost';
            cost.textContent = unit.costPerModel ? `${unit.costPerModel} pts/model` : `${unit.cost} pts`;
            
            header.appendChild(name);
            header.appendChild(cost);
            
            const stats = document.createElement('div');
            stats.className = 'unit-stats';
            ['M', 'WS', 'BS', 'S', 'T', 'W', 'I', 'A', 'Ld'].forEach(stat => {
                const statDiv = document.createElement('div');
                statDiv.className = 'stat';
                statDiv.innerHTML = `<div class="stat-label">${stat}</div><div>${unit.stats[stat]}</div>`;
                stats.appendChild(statDiv);
            });
            
            const rules = document.createElement('div');
            rules.className = 'special-rules';
            rules.textContent = `Special Rules: ${unit.specialRules.join(', ')}`;
            
            const addBtn = document.createElement('button');
            addBtn.textContent = 'Add to Army';
            addBtn.onclick = () => addUnitToArmy(unit);
            
            card.appendChild(header);
            card.appendChild(stats);
            card.appendChild(rules);
            card.appendChild(addBtn);
            
            return card;
        }

        function addUnitToArmy(unit) {
            const armyUnit = {
                id: nextUnitId++,
                unitData: unit,
                modelCount: unit.minSize || 1,
                selectedOptions: [],
                selectedMagicItems: []
            };
            
            currentArmy.push(armyUnit);
            renderArmyList();
            updateTotalPoints();
            saveArmyToStorage();
        }

        function renderArmyList() {
            const list = document.getElementById('armyList');
            list.innerHTML = '';
            
            if (currentArmy.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #aaa; padding: 40px;">Your army is empty. Add units from the browser!</div>';
                return;
            }
            
            currentArmy.forEach(armyUnit => {
                list.appendChild(createArmyUnitCard(armyUnit));
            });
        }

        function createArmyUnitCard(armyUnit) {
            const card = document.createElement('div');
            card.className = 'army-unit';
            
            const header = document.createElement('div');
            header.className = 'army-unit-header';
            
            const name = document.createElement('div');
            name.className = 'unit-name';
            name.textContent = armyUnit.unitData.name;
            
            const cost = document.createElement('div');
            cost.className = 'unit-cost';
            cost.textContent = `${calculateUnitCost(armyUnit)} pts`;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => removeUnit(armyUnit.id);
            
            header.appendChild(name);
            header.appendChild(cost);
            header.appendChild(removeBtn);
            
            card.appendChild(header);
            
            // Model count for units with multiple models
            if (armyUnit.unitData.costPerModel) {
                const modelCount = document.createElement('div');
                modelCount.className = 'model-count';
                modelCount.innerHTML = `
                    <label>Models:</label>
                    <input type="number" 
                           min="${armyUnit.unitData.minSize || 1}" 
                           value="${armyUnit.modelCount}" 
                           onchange="updateModelCount(${armyUnit.id}, this.value)">
                `;
                card.appendChild(modelCount);
            }
            
            // Options
            if (armyUnit.unitData.options && armyUnit.unitData.options.length > 0) {
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'options-container';
                
                armyUnit.unitData.options.forEach(option => {
                    const optionItem = document.createElement('div');
                    optionItem.className = 'option-item';
                    
                    const checkbox = document.createElement('div');
                    checkbox.className = 'option-checkbox';
                    checkbox.innerHTML = `
                        <input type="checkbox" 
                               id="opt-${armyUnit.id}-${option.name}" 
                               ${armyUnit.selectedOptions.includes(option.name) ? 'checked' : ''}
                               onchange="toggleOption(${armyUnit.id}, '${option.name}')">
                        <label for="opt-${armyUnit.id}-${option.name}">${option.name}</label>
                    `;
                    
                    const optCost = document.createElement('div');
                    optCost.className = 'unit-cost';
                    const totalOptionCost = option.costPerModel 
                        ? option.costPerModel * armyUnit.modelCount 
                        : option.cost;
                    optCost.textContent = `${totalOptionCost} pts`;
                    
                    optionItem.appendChild(checkbox);
                    optionItem.appendChild(optCost);
                    optionsDiv.appendChild(optionItem);
                });
                
                card.appendChild(optionsDiv);
            }
            
            // Magic Items for characters
            if (armyUnit.unitData.magicItemLimit) {
                const magicDiv = document.createElement('div');
                magicDiv.className = 'magic-items-section';
                magicDiv.innerHTML = '<div class="magic-item-title">Magic Items</div>';
                
                const spentPoints = calculateMagicItemsTotal(armyUnit);
                const limit = armyUnit.unitData.magicItemLimit;
                magicDiv.innerHTML += `<div style="color: ${spentPoints > limit ? '#ff6b6b' : '#aaa'}; font-size: 0.9em; margin-bottom: 10px;">
                    ${spentPoints} / ${limit} pts spent
                </div>`;
                
                ['weapons', 'armour', 'talismans', 'enchanted', 'arcane'].forEach(category => {
                    if (armyData.magicItems[category]) {
                        const items = armyData.magicItems[category].filter(item => {
                            if (item.wizardOnly && !armyUnit.unitData.specialRules.includes('Wizard')) return false;
                            if (item.restrictedTo && !item.restrictedTo.includes(armyUnit.unitData.id)) return false;
                            return true;
                        });
                        
                        if (items.length > 0) {
                            const catDiv = document.createElement('div');
                            catDiv.className = 'magic-item-category';
                            catDiv.innerHTML = `<div style="color: #ff6b35; font-size: 0.9em; margin-top: 10px;">${category.charAt(0).toUpperCase() + category.slice(1)}</div>`;
                            
                            items.forEach(item => {
                                const itemDiv = document.createElement('div');
                                itemDiv.className = 'magic-item';
                                if (armyUnit.selectedMagicItems.includes(item.id)) {
                                    itemDiv.classList.add('selected');
                                }
                                itemDiv.onclick = () => toggleMagicItem(armyUnit.id, item.id);
                                itemDiv.innerHTML = `
                                    <div class="magic-item-header">
                                        <span>${item.name}</span>
                                        <span class="unit-cost">${item.cost} pts</span>
                                    </div>
                                    <div class="magic-item-desc">${item.description}</div>
                                `;
                                catDiv.appendChild(itemDiv);
                            });
                            
                            magicDiv.appendChild(catDiv);
                        }
                    }
                });
                
                card.appendChild(magicDiv);
            }
            
            return card;
        }

        function toggleCategory(categoryKey) {
            const element = document.getElementById(`category-${categoryKey}`);
            element.classList.toggle('hidden');
        }

        function updateModelCount(unitId, newCount) {
            const unit = currentArmy.find(u => u.id === unitId);
            if (unit) {
                unit.modelCount = parseInt(newCount);
                renderArmyList();
                updateTotalPoints();
                saveArmyToStorage();
            }
        }

        function toggleOption(unitId, optionName) {
            const unit = currentArmy.find(u => u.id === unitId);
            if (unit) {
                const index = unit.selectedOptions.indexOf(optionName);
                if (index > -1) {
                    unit.selectedOptions.splice(index, 1);
                } else {
                    unit.selectedOptions.push(optionName);
                }
                renderArmyList();
                updateTotalPoints();
                saveArmyToStorage();
            }
        }

        function toggleMagicItem(unitId, itemId) {
            const unit = currentArmy.find(u => u.id === unitId);
            if (unit) {
                const index = unit.selectedMagicItems.indexOf(itemId);
                if (index > -1) {
                    unit.selectedMagicItems.splice(index, 1);
                } else {
                    unit.selectedMagicItems.push(itemId);
                }
                renderArmyList();
                updateTotalPoints();
                saveArmyToStorage();
            }
        }

        function calculateUnitCost(armyUnit) {
            let cost = armyUnit.unitData.costPerModel 
                ? armyUnit.unitData.costPerModel * armyUnit.modelCount
                : armyUnit.unitData.cost;
            
            // Add option costs
            armyUnit.selectedOptions.forEach(optName => {
                const option = armyUnit.unitData.options.find(o => o.name === optName);
                if (option) {
                    cost += option.costPerModel 
                        ? option.costPerModel * armyUnit.modelCount
                        : option.cost;
                }
            });
            
            // Add magic item costs
            cost += calculateMagicItemsTotal(armyUnit);
            
            return cost;
        }

        function calculateMagicItemsTotal(armyUnit) {
            let total = 0;
            armyUnit.selectedMagicItems.forEach(itemId => {
                for (const category of Object.values(armyData.magicItems)) {
                    const item = category.find(i => i.id === itemId);
                    if (item) {
                        total += item.cost;
                        break;
                    }
                }
            });
            return total;
        }

        function removeUnit(unitId) {
            currentArmy = currentArmy.filter(u => u.id !== unitId);
            renderArmyList();
            updateTotalPoints();
            saveArmyToStorage();
        }

        function updateTotalPoints() {
            const total = currentArmy.reduce((sum, unit) => sum + calculateUnitCost(unit), 0);
            document.getElementById('totalPoints').textContent = total;
        }

        function clearArmy() {
            if (confirm('Are you sure you want to clear your army?')) {
                currentArmy = [];
                renderArmyList();
                updateTotalPoints();
                saveArmyToStorage();
            }
        }

        function saveArmyToStorage() {
            localStorage.setItem('beastmenArmy', JSON.stringify(currentArmy));
        }

        function loadArmyFromStorage() {
            const saved = localStorage.getItem('beastmenArmy');
            if (saved) {
                currentArmy = JSON.parse(saved);
                renderArmyList();
                updateTotalPoints();
            }
        }

        function saveArmy() {
            const dataStr = JSON.stringify(currentArmy, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'beastmen-army.json';
            link.click();
        }

        function loadArmy() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        currentArmy = JSON.parse(event.target.result);
                        renderArmyList();
                        updateTotalPoints();
                        saveArmyToStorage();
                    } catch (error) {
                        alert('Error loading army file');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportText() {
            let text = `BEASTMEN BRAYHERDS ARMY LIST\n`;
            text += `Total Points: ${currentArmy.reduce((sum, unit) => sum + calculateUnitCost(unit), 0)}\n\n`;
            
            currentArmy.forEach(armyUnit => {
                text += `${armyUnit.unitData.name}`;
                if (armyUnit.unitData.costPerModel) {
                    text += ` (${armyUnit.modelCount} models)`;
                }
                text += ` - ${calculateUnitCost(armyUnit)} pts\n`;
                
                if (armyUnit.selectedOptions.length > 0) {
                    text += `  Options: ${armyUnit.selectedOptions.join(', ')}\n`;
                }
                
                if (armyUnit.selectedMagicItems.length > 0) {
                    const items = [];
                    armyUnit.selectedMagicItems.forEach(itemId => {
                        for (const category of Object.values(armyData.magicItems)) {
                            const item = category.find(i => i.id === itemId);
                            if (item) items.push(item.name);
                        }
                    });
                    text += `  Magic Items: ${items.join(', ')}\n`;
                }
                text += `\n`;
            });
            
            const blob = new Blob([text], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'beastmen-army.txt';
            link.click();
        }

        // Initialize on page load
        loadArmyData();
    </script>
</body>
</html>
